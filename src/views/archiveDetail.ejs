<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Veiltrace Archive</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <style type="text/css">
    @media (min-width: 384px)  { #veiltrace-grid { grid-template-columns: repeat(1, minmax(0, 1fr)); } }
    @media (min-width: 480px)  { #veiltrace-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    @media (min-width: 640px)  { #veiltrace-grid { grid-template-columns: repeat(3, minmax(0, 1fr)); } }
    @media (min-width: 768px)  { #veiltrace-grid { grid-template-columns: repeat(4, minmax(0, 1fr)); } }
    @media (min-width: 1024px) { #veiltrace-grid { grid-template-columns: repeat(5, minmax(0, 1fr)); } }
    @media (min-width: 1280px) { #veiltrace-grid { grid-template-columns: repeat(6, minmax(0, 1fr)); } }
    @media (min-width: 1440px) { #veiltrace-grid { grid-template-columns: repeat(7, minmax(0, 1fr)); } }
    @media (min-width: 1680px) { #veiltrace-grid { grid-template-columns: repeat(8, minmax(0, 1fr)); } }
    @media (min-width: 1920px) { #veiltrace-grid { grid-template-columns: repeat(9, minmax(0, 1fr)); } }
    @media (min-width: 2560px) { #veiltrace-grid { grid-template-columns: repeat(10, minmax(0, 1fr)); } }
  </style>
  <script src="/assets/tailwind.js"></script>
</head>
<body class="bg-gray-50 text-gray-900">

  <div class="max-w-7xl mx-auto pt-6 pb-2 px-6">
      <!-- Header -->
      <header class="mb-4 text-center cursor-pointer" onclick="location.reload()">
        <h1 class="text-3xl font-serif font-semibold tracking-tight">Veiltrace Archive</h1>
      </header>
   
    <!-- Search Results -->
    <div id="matchCount" class="px-6 text-sm bold text-black mx-2 my-2">
      <% if (imageIds) { %> 
        <%= imageIds.length %> image<%= imageIds.length>1? "s":"" %>
      <% } %>
    </div>

    <% if (imageIds && imageIds.length > 0) { %>
      <form id="exportForm" action="/export" method="POST">

        <!-- Action Buttons -->
        <div class="flex items-center justify-start gap-4 mb-6 px-6">
          <button type="button" id="selectAll"
                class="px-4 py-2 bg-indigo-200 text-indigo-800 rounded hover:bg-indigo-300 transition">
            Select All
          </button>
          <button type="button" id="unselectAll"
                class="px-4 py-2 bg-indigo-200 text-indigo-800 rounded hover:bg-indigo-300 transition">
            Unselect All
          </button>
          <button type="button" id="invertSelect"
                class="px-4 py-2 bg-indigo-200 text-indigo-800 rounded hover:bg-indigo-300 transition">
            Invert Select
          </button>

          <button type="submit"
          class="px-6 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition">
            Export Selection
          </button>

          <!-- <button type="submit" formaction="/archive"
          class="px-6 py-2 bg-cyan-600 text-white rounded hover:bg-cyan-700 transition">
            Remove from Archive
          </button> -->

          <button type="submit" formaction="/archive"
          class="px-6 py-2 bg-cyan-600 text-white rounded hover:bg-cyan-700 transition">
            Add to Archive
          </button>

          <button type="button" class="px-6 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition font-bold"
                  onclick="removeFromArchive('<%= id %>')">
            Remove from Archive
          </button>

        </div>

        <!-- Image Grid -->
        <!-- <div class="px-6 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 gap-6"> -->
        <!-- <div class="px-6 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 2xl:grid-cols-8 gap-6"> -->
        <!-- <div class="px-6 grid gap-6 grid-cols-1" id="veiltrace-grid"> -->
        <div class="grid px-6 gap-6" id="veiltrace-grid">
          <% imageIds.forEach((item, index) => { %>
            <div class="relative border rounded shadow p-2 bg-white">
              <!-- Top Overlay -->
              <div class="absolute top-2 left-2 bg-white bg-opacity-80 px-2 py-1 rounded text-xs font-medium flex items-center space-x-2">
                <span><%= index + 1 %></span>
                <input class="text-bold" type="checkbox" name="selected" value="<%= item %>">
              </div>

              <!-- Image Preview -->
              <a href="/view/<%= item %>" target="_blank" title="ImageId is <%= item %>">
                <img src="/api/v1/image/preview/<%= item %>"
                     alt="Preview <%= item %>"
                     class="w-full h-32 object-cover rounded mt-2">
              </a>

            </div>
          <% }) %>
        </div>
      </form>
    <% } %>

    <% if (imageIds.length === 0) { %>
      <p class="text-center text-xl text-gray-900 font-medium my-12 font-serif">
        The archive is currently empty — no image has been added yet.
      </p>
    <% } %>
  </div>

  <div class="flex justify-center items-center h-12">
    <button onclick="window.close()"
            class="inline-block px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition cursor-pointer">
      Close
    </button>
  </div>

  <!-- Copilot Credit -->
  <footer class="m-4 text-center text-sm text-gray-700">
    <p>
      Crafted in quiet partnership with  
      <a href="https://copilot.microsoft.com" target="_blank" class="text-blue-600 font-semibold hover:underline">
        Microsoft Copilot
      </a> — <br />your poetic companion in code, ritual, and breath. Veiltrace. All traces remembered.
    </p>
  </footer>
  
  <!-- Client-side Logic -->
  <script type="text/javascript">
    const exportForm = document.getElementById('exportForm');
    const selectAllBtn = document.getElementById('selectAll');
    const unselectAllBtn = document.getElementById('unselectAll');
    const invertSelectBtn = document.getElementById('invertSelect');

    exportForm?.addEventListener('submit', function (e) {
      const checked = document.querySelectorAll('input[name="selected"]:checked');
      if (checked.length === 0) {
        e.preventDefault();
        alert('Please select at least one preview.');
      }
    });

    selectAllBtn?.addEventListener('click', () => {
      document.querySelectorAll('input[name="selected"]').forEach(cb => cb.checked = true);
    });

    unselectAllBtn?.addEventListener('click', () => {
      document.querySelectorAll('input[name="selected"]').forEach(cb => cb.checked = false);
    });

    invertSelectBtn?.addEventListener('click', () => {
      document.querySelectorAll('input[name="selected"]').forEach(cb => cb.checked = ! cb.checked);
    });
  </script>

  <script type="text/javascript">
    function removeFromArchive(archiveId) {
      const ids = Array.from(document.querySelectorAll('input[name="selected"]:checked')).map(cb => Number(cb.value));

      console.log('archiveId = ', archiveId)
      console.log('ids-', ids)

      if (ids.length > 0) {
        if (!confirm(`Are you sure you want to remove '[${ids}]' from archive '${archiveId}'?`)) return;

        const payload = {
          action: 'remove', 
          ids
        };

        fetch(`/api/v1/image/archive/${archiveId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        })
        .then(response => {
          if (response.ok) {
            //alert('Image removed from archive.');
            // Optionally refresh or redirect
            location.reload();
          } else {
            alert('Failed to remove image.');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('An error occurred.');
        });
      }
    }
  </script>
</body>
</html>