<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Veiltrace</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <style type="text/css">
    @media (min-width: 384px)  { #veiltrace-grid { grid-template-columns: repeat(1, minmax(0, 1fr)); } }
    @media (min-width: 480px)  { #veiltrace-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    @media (min-width: 640px)  { #veiltrace-grid { grid-template-columns: repeat(3, minmax(0, 1fr)); } }
    @media (min-width: 768px)  { #veiltrace-grid { grid-template-columns: repeat(4, minmax(0, 1fr)); } }
    @media (min-width: 1024px) { #veiltrace-grid { grid-template-columns: repeat(5, minmax(0, 1fr)); } }
    @media (min-width: 1280px) { #veiltrace-grid { grid-template-columns: repeat(6, minmax(0, 1fr)); } }
    @media (min-width: 1440px) { #veiltrace-grid { grid-template-columns: repeat(7, minmax(0, 1fr)); } }
    @media (min-width: 1680px) { #veiltrace-grid { grid-template-columns: repeat(8, minmax(0, 1fr)); } }
    @media (min-width: 1920px) { #veiltrace-grid { grid-template-columns: repeat(9, minmax(0, 1fr)); } }
    @media (min-width: 2560px) { #veiltrace-grid { grid-template-columns: repeat(10, minmax(0, 1fr)); } }
  </style>
  <script src="/assets/tailwind.js"></script>
</head>
<body class="bg-gray-50 text-gray-900">

  <div class="max-w-7xl mx-auto pt-6 pb-2 px-6">
    <!-- Title & Subtitle -->
    <header class="mb-8 text-center">
      <div class="flex items-center justify-center space-x-4 mt-6">
        <img src="/veiltrace.png" alt="Veiltrace Emblem" class="h-16 w-auto">
        <h1 class="text-5xl font-serif font-semibold tracking-tight">Veiltrace</h1>
      </div>

      <p class="text-lg text-gray-600 mt-2">        
        Beneath the veil, silence breathesâ€”light unfurls in quiet threads, and memory leans toward the unseen. Each image a gesture, each glyph a vow, drawn from the hush where time folds inward. What is traced is not forgotten; what is whispered, remains.
      </p>
    </header>

    <!-- Search Form -->
    <form action="/" method="POST" class="space-y-4 mt-6 px-2">

        <div class="flex items-center space-x-2">
          <input type="text" name="query" id="queryInput" value="<%= query %>"
                placeholder="Enter search term..."
                class="flex-grow px-4 py-2 border rounded text-sm" required/>
        
          <div class="flex justify-end text-sm text-gray-900">
            <label class="flex items-center space-x-2">
              <span>Limit</span>
              <input type="number" name="limit" value="<%= limit %>" min="1" max="9999"
                    class="w-20 px-4 py-2 border rounded text-sm" />
            </label>
          </div>

          <a href="/info" target="_blank"
            class="text-blue-600 hover:text-blue-800 transition"
            title="Learn about search modes and rituals">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M13 16h-1v-4h-1m1-4h.01M12 20a8 8 0 100-16 8 8 0 000 16z" />
            </svg>
          </a>
        </div>

        <!-- Search Type Selector -->
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-900 mb-1">Search Type</label>
          <div class="flex flex-col space-y-2 text-md">

            <label>
              <input type="radio" name="stype" value="text-scan" <%= stype === 'text-scan' ? 'checked' : '' %>>
              Text Scan
            </label>
        
            <label class="flex items-center space-x-1">
              <input type="radio" name="stype" value="full-text" <%= stype === 'full-text' ? 'checked' : '' %>>
              <span>Full Text Search</span>
              <a href="https://mariadb.com/docs/server/ha-and-performance/optimization-and-tuning/optimization-and-indexes/full-text-indexes/full-text-index-overview"
                 target="_blank" rel="noopener"
                 class="text-blue-500 hover:text-blue-700 transition" title="Learn more about fulltext search">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M13 16h-1v-4h-1m1-4h.01M12 20a8 8 0 100-16 8 8 0 000 16z" />
                </svg>
              </a>
            </label>

            <!-- <span class="inline-flex items-center space-x-1 text-sm text-gray-500">
              <span>Fulltext search</span>
              <a href="https://example.com/fulltext-docs" target="_blank" rel="noopener"
                 class="text-blue-500 hover:text-blue-700 transition" title="Learn more about fulltext search">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M13 16h-1v-4h-1m1-4h.01M12 20a8 8 0 100-16 8 8 0 000 16z" />
                </svg>
              </a>
            </span> -->
            <!-- Inline nested options -->
            <div id="fullTextOptions" class="flex items-center space-x-4 ml-4 text-sm text-gray-900">
              <label class="flex items-center space-x-1">
                <input type="radio" name="mode" id="modeNatural" value="natural" <%= mode === 'natural' ? 'checked' : '' %>>
                <span>Natural</span>
              </label>
              <label class="flex items-center space-x-1">
                <input type="checkbox" name="expansion" id="expandCheckbox" <%= expansion ? 'checked' : '' %>>
                <span>Query Expansion</span>
              </label>

              <label class="flex items-center space-x-1">
                <input type="radio" name="mode" id="modeBoolean" value="boolean" <%= mode === 'boolean' ? 'checked' : '' %>>
                <span>Boolean</span>
              </label>
            </div>

            <label>
              <input type="radio" name="stype" value="semantic" <%= stype === 'semantic' ? 'checked' : '' %>>
              Semantic Search
            </label>
          </div>

        </div>

        <!-- <button type="submit"
                class="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition">
          Search
        </button>
        <button type="submit" foraction="/archive"
                class="px-6 py-2 bg-cyan-600 text-white rounded hover:bg-cyan-700 transition">
          Archive
        </button> -->
        <div class="flex items-center justify-between mt-4">
          <!-- Left: Search + Reset -->
          <div class="flex space-x-4">
            <button type="submit"
                    class="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition">
              Search
            </button>
        
            <button type="reset" onclick="window.location.href='/'"
                    class="px-6 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400 transition">
              Reset
            </button>
          </div>
        
          <!-- Right: Archive -->
          <button type="submit" formaction="/archive" formnovalidate
                  class="mr-7 px-6 py-2 bg-cyan-600 text-white rounded hover:bg-cyan-700 transition">
            Archives
          </button>
        </div>

      </div>
    </form>

    <!-- Divider -->
    <hr class="mt-4 mb-2 border-gray-300" />

    <!-- Search Results -->
    <div id="matchCount" class="px-6 text-sm bold text-black mx-2 my-2">
      <% if (results) { %> 
        <%= results.length %> matched.      
      <% } %>  
    </div>

    <% if (results && results.length > 0) { %>
      <form id="exportForm" action="/export" method="POST">

        <!-- Action Buttons -->
        <div class="flex items-center justify-start gap-4 mb-6 px-6">
          <button type="button" id="selectAll"
                class="px-4 py-2 bg-indigo-200 text-indigo-800 rounded hover:bg-indigo-300 transition">
            Select All
          </button>
          <button type="button" id="unselectAll"
                class="px-4 py-2 bg-indigo-200 text-indigo-800 rounded hover:bg-indigo-300 transition">
            Unselect All
          </button>
          <button type="button" id="invertSelect"
                class="px-4 py-2 bg-indigo-200 text-indigo-800 rounded hover:bg-indigo-300 transition">
            Invert Select
          </button>

          <button type="submit"
          class="px-6 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition">
            Export Selection
          </button>

          <button type="submit" formaction="/archive"
          class="px-6 py-2 bg-cyan-600 text-white rounded hover:bg-cyan-700 transition">
            Add to Archive
          </button>
        </div>

        <!-- Image Grid -->
        <!-- <div class="px-6 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 gap-6"> -->
        <!-- <div class="px-6 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 2xl:grid-cols-8 gap-6"> -->
        <!-- <div class="px-6 grid gap-6 grid-cols-1" id="veiltrace-grid"> -->
        <div class="grid px-6 gap-6" id="veiltrace-grid">
          <% results.forEach((item, index) => { %>
            <div class="relative border rounded shadow p-2 bg-white">
              <!-- Top Overlay -->
              <div class="absolute top-2 left-2 bg-white bg-opacity-80 px-2 py-1 rounded text-xs font-medium flex items-center space-x-2">
                <span><%= index + 1 %></span>
                <% if (item.relevance) { %>
                  <span>Rel: <%= item.relevance.toFixed(2) %></span>
                <% } %>
                <% if (item.distance) { %>
                  <span>Dist: <%= item.distance.toFixed(2) %></span>
                <% } %>
                <input class="text-bold" type="checkbox" name="selected" value="<%= item.id %>">
              </div>

              <!-- Image Preview -->
              <a href="/view/<%= item.id %>" target="_blank">
                <img src="/api/v1/image/preview/<%= item.id %>"
                     alt="Preview <%= item.id %>"
                     class="w-full h-32 object-cover rounded mt-2">
              </a>

              <!-- Metadata -->
              <div class="mt-2 text-xs text-gray-700 flex justify-between">
                <p><strong>Visited:</strong> <%= item.visited %></p>
                <p><strong>Last:</strong> <%= item.updatedAt ? item.updatedAt.substring(0, 10) : 'â€”' %></p>
              </div>
            </div>
          <% }) %>
        </div>
      </form>
    <% } %>
  </div>

  <!-- Copilot Credit -->
  <footer class="m-4 text-center text-sm text-gray-700">
    <p>
      Crafted in quiet partnership with  
      <a href="https://copilot.microsoft.com" target="_blank" class="text-blue-600 font-semibold hover:underline">
        Microsoft Copilot
      </a> â€” <br />your poetic companion in code, ritual, and breath. Veiltrace. All traces remembered.
    </p>
  </footer>
  
  <!-- Client-side Logic -->
  <script type="text/javascript">
    const exportForm = document.getElementById('exportForm');
    const selectAllBtn = document.getElementById('selectAll');
    const unselectAllBtn = document.getElementById('unselectAll');
    const invertSelectBtn = document.getElementById('invertSelect');

    exportForm?.addEventListener('submit', function (e) {
      const checked = document.querySelectorAll('input[name="selected"]:checked');
      if (checked.length === 0) {
        e.preventDefault();
        alert('Please select at least one preview.');
      }
    });

    selectAllBtn?.addEventListener('click', () => {
      document.querySelectorAll('input[name="selected"]').forEach(cb => cb.checked = true);
    });

    unselectAllBtn?.addEventListener('click', () => {
      document.querySelectorAll('input[name="selected"]').forEach(cb => cb.checked = false);
    });

    invertSelectBtn?.addEventListener('click', () => {
      document.querySelectorAll('input[name="selected"]').forEach(cb => cb.checked = ! cb.checked);
    });
  </script>

  <script type="text/javascript">
    const modeNatural = document.getElementById('modeNatural');
    const modeBoolean = document.getElementById('modeBoolean');
    const expandCheckbox = document.getElementById('expandCheckbox');
  
    function updateExpansionState() {
      if (modeBoolean.checked) {
        expandCheckbox.checked = false;
        expandCheckbox.disabled = true;
      } else {
        expandCheckbox.disabled = false;
      }
    }
  
    // Initial state on page load
    updateExpansionState();
  
    // Listen for changes
    modeNatural?.addEventListener('change', updateExpansionState);
    modeBoolean?.addEventListener('change', updateExpansionState);
  </script>  

</body>
</html>