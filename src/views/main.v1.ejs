<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Veiltrace</title>
  <script src="/assets/tailwind.js"></script>
</head>
<body class="bg-gray-50 text-gray-800">

  <div class="max-w-7xl mx-auto py-10 px-6">
    <!-- Title & Subtitle -->
    <header class="mb-8 text-center">
      <h1 class="text-4xl font-bold tracking-wide">Veiltrace</h1>
      <p class="text-lg text-gray-600 mt-2">        
        Beneath the veil, the silence stirs— a thread of light, a whisper caught. 
        Each query a gesture, each image a trace, drawn from the hush where memory waits.
        Every trace, every glyph, every whisper shaped with intention.
      </p>
    </header>

    <!-- Search Form -->
    <form action="/" method="POST" class="space-y-4 mt-6 px-2">

      <div class="flex items-center space-x-2">
        <input type="text" name="query" id="queryInput" value="<%= query %>"
               placeholder="Enter search term..."
               class="flex-grow px-4 py-2 border rounded text-sm" />
      
        <a href="/info" target="_blank"
           class="text-blue-600 hover:text-blue-800 transition"
           title="Learn about search modes and rituals">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
               viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M13 16h-1v-4h-1m1-4h.01M12 20a8 8 0 100-16 8 8 0 000 16z" />
          </svg>
        </a>
      </div>

      <!-- Mode Selection, Query Expansion and Max. Return -->
      <div class="flex flex-wrap items-center gap-4">
        <label class="flex items-center space-x-2">
          <input type="radio" name="mode" id="modeNatural" value="natural" <%= mode === 'natural' ? 'checked' : '' %>>
          <span>Natural Language Mode</span>
        </label>

        <label class="flex items-center space-x-2">
          <input type="checkbox" name="expansion" id="expandCheckbox" <%= expansion ? 'checked' : '' %>>
          <span>Query Expansion</span>
        </label>

        <label class="flex items-center space-x-2 ml-6">
          <input type="radio" name="mode" id="modeBoolean" value="boolean" <%= mode === 'boolean' ? 'checked' : '' %>>
          <span>Boolean Mode</span>
        </label>

        <label class="flex items-center space-x-2 ml-6" for="maxReturns">Limit</label>
        <input type="number" name="limit" id="maxReturns"
               value="<%= limit %>" min="1" max="1000"
               class="w-20 px-2 py-1 border rounded text-sm" />
      </div>
      
      <div class="flex space-x-4">
        <button type="submit"
                class="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition">
          Search
        </button>
      </div>
    </form>

    <!-- Divider -->
    <hr class="mt-4 mb-2 border-gray-300" />

    <!-- Search Results -->
    <div id="matchCount" class="text-sm text-gray-900 mx-2 my-2">
      <% if (results) { %> 
        <%= results.length %> matched.
      <% } else { %>
        Enter search item...
      <% } %>  
    </div>

    <% if (results && results.length > 0) { %>
      <form id="exportForm" action="/export" method="POST">

        <!-- Action Buttons -->
        <div class="flex items-center justify-start gap-4 mb-6">
          <button type="button" id="selectAll"
                class="px-4 py-2 bg-indigo-200 text-indigo-800 rounded hover:bg-indigo-300 transition">
            Select All
          </button>
          <button type="button" id="unselectAll"
                class="px-4 py-2 bg-indigo-200 text-indigo-800 rounded hover:bg-indigo-300 transition">
            Unselect All
          </button>
          <button type="button" id="invertSelect"
                class="px-4 py-2 bg-indigo-200 text-indigo-800 rounded hover:bg-indigo-300 transition">
            Invert Select
          </button>

          <button type="submit"
          class="px-6 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition">
            Export Selection
          </button>

        </div>

        <!-- Image Grid -->
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 gap-6">
          <% results.forEach((item, index) => { %>
            <div class="relative border rounded shadow p-2 bg-white">
              <!-- Top Overlay -->
              <div class="absolute top-2 left-2 bg-white bg-opacity-80 px-2 py-1 rounded text-xs font-medium flex items-center space-x-2">
                <span><%= index + 1 %></span>
                <span>Rel: <%= item.relevance.toFixed(2) %></span>
                <input type="checkbox" name="selected" value="<%= item.id %>">
              </div>

              <!-- Image Preview -->
              <a href="/image/<%= item.id %>" target="_blank">
                <img src="/api/v1/image/preview/<%= item.id %>"
                     alt="Preview <%= item.id %>"
                     class="w-full h-32 object-cover rounded mt-2">
              </a>

              <!-- Metadata -->
              <div class="mt-2 text-xs text-gray-700 flex justify-between">
                <p><strong>Visited:</strong> <%= item.visited %></p>
                <p><strong>Last Updated:</strong> <%= item.updatedAt ? item.updatedAt.substring(0, 10) : '———' %></p>
              </div>
            </div>
          <% }) %>
        </div>
      </form>
    <% } else if (results) { %>
      <p class="mt-10 text-center text-gray-500">No results found.</p>
    <% } %>
  </div>

  <!-- Copilot Credit -->
  <div class="mt-10 mb-6 text-center text-sm text-gray-700">
    <p>
      Crafted in quiet partnership with  
      <a href="https://copilot.microsoft.com" target="_blank" class="text-blue-600 font-semibold hover:underline">
        Microsoft Copilot
      </a> — your poetic companion in code, ritual, and breath.
    </p>
  </div>
  
  <!-- Client-side Logic -->
  <script>
    const exportForm = document.getElementById('exportForm');
    const selectAllBtn = document.getElementById('selectAll');
    const unselectAllBtn = document.getElementById('unselectAll');
    const invertSelectBtn = document.getElementById('invertSelect');

    exportForm?.addEventListener('submit', function (e) {
      const checked = document.querySelectorAll('input[name="selected"]:checked');
      if (checked.length === 0) {
        e.preventDefault();
        alert('Please select at least one preview before exporting.');
      }
    });

    selectAllBtn?.addEventListener('click', () => {
      document.querySelectorAll('input[name="selected"]').forEach(cb => cb.checked = true);
    });

    unselectAllBtn?.addEventListener('click', () => {
      document.querySelectorAll('input[name="selected"]').forEach(cb => cb.checked = false);
    });

    invertSelectBtn?.addEventListener('click', () => {
      document.querySelectorAll('input[name="selected"]').forEach(cb => cb.checked = ! cb.checked);
    });
  </script>

<script>
    const modeNatural = document.getElementById('modeNatural');
    const modeBoolean = document.getElementById('modeBoolean');
    const expandCheckbox = document.getElementById('expandCheckbox');
  
    function updateExpansionState() {
      if (modeBoolean.checked) {
        expandCheckbox.checked = false;
        expandCheckbox.disabled = true;
      } else {
        expandCheckbox.disabled = false;
      }
    }
  
    // Initial state on page load
    updateExpansionState();
  
    // Listen for changes
    modeNatural?.addEventListener('change', updateExpansionState);
    modeBoolean?.addEventListener('change', updateExpansionState);
  </script>  

</body>
</html>