<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Veiltrace Archive</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 text-gray-800">
  <div class="max-w-3xl mx-auto py-10 px-6">
    <h1 class="text-3xl font-semibold mb-6 text-indigo-700">üìú Archive List</h1>

    <!-- üßæ New Archive Form -->
    <% if (ids && ids.length > 0 ) { %> 
      <form id="archiveForm" method="post" action="/api/v1/image/archive" class="mb-8 bg-white p-6 rounded-lg shadow-sm border border-gray-200">
        <label for="description" class="block text-sm font-medium text-gray-700 mb-2">Description</label>      
        <input type="text" id="description" name="description" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" 
          placeholder="Enter a poetic description..." autofocus required />

        <button type="submit" class="mt-4 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded shadow-sm">
          Add to New Archive
        </button>
      </form>
      <hr />
    <% } %>


    <!-- üßæ Archive List -->
    <ol class="space-y-6 list-none">
      <% archives.forEach((item, index) => { %>
        <li class="flex items-start space-x-4">
          <!-- Left Column: Number + Button -->
          <div class="flex flex-col items-center w-16 flex-shrink-0">
            <div class="text-xl font-bold text-indigo-700 mb-2">
              <%= index + 1 %>.
            </div>
            <% if (ids && ids.length > 0 ) { %> 
              <button class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded shadow-sm text-sm" onclick="addToArchive('<%= item.id %>')">
                To here
              </button>
            <% } %>
          </div>

          <!-- Right Column: Archive Block -->
          <a href="/archivedetails/<%= item.id %>" class="flex-1 block bg-white shadow-sm hover:shadow-md transition rounded-lg p-4 border border-gray-200 hover:border-indigo-300">
            <div class="text-lg font-bold text-indigo-600 mb-1">
              <%= item.description %>
            </div>
            <div class="text-sm text-gray-600">
              üï∞Ô∏è Created: <%= item.createdAt %>
              <% if (item.updatedAt) { %>
                | üîÑ Updated: <%= item.updatedAt %>
              <% } %>
              | üî¢ Update Ident: <%= item.updateIdent %>
            </div>
            <div class="mt-2 text-sm text-gray-700">
              üñºÔ∏è Image IDs:
              <% try { %>
                <% const imageArray = JSON.parse(item.imageIds); %>
                <% if (imageArray.length === 0) { %>
                  <span class="text-gray-400 italic">No images</span>
                <% } else { %>
                  <% imageArray.forEach(id => { %>
                    <span class="inline-block bg-indigo-100 text-indigo-800 px-2 py-1 rounded mr-1 mb-1"><%= id %></span>
                  <% }) %>
                <% } %>
              <% } catch (e) { %>
                <span class="text-red-500">Invalid imageIds</span>
              <% } %>
            </div>
          </a>
        </li>
      <% }) %>
    </ol>
  </div>

  <!-- üß† Script -->
  <script>
    const ids = '<%- JSON.stringify(ids) %>';
    console.log('ids = ', ids)

    document.getElementById('archiveForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      const description = document.getElementById('description').value;

      try {
        const response = await fetch('/api/v1/image/archive', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ description, ids })
        });

        if (response.ok) {
          // alert('New archive created successfully.');
          location.reload();
        } else {
          const error = await response.json();
          alert(`Failed: ${error.message}`);
        }
      } catch (err) {
        console.error('Error:', err);
        alert('Request failed.');
      }
    });

    async function addToArchive(archiveId) {
      try {
        const response = await fetch(`/api/v1/image/archive/${archiveId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ids })
        });

        if (response.ok) {
          //alert(`Added ${ids.length} image(s) to archive ${archiveId}`);
          location.reload();
        } else {
          const error = await response.json();
          alert(`Failed: ${error.message}`);
        }
      } catch (err) {
        console.error('Error:', err);
        alert('Request failed.');
      }
    }
  </script>
</body>
</html>